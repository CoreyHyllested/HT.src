{% extends "ht_header.html" %}

{% block head %}
	{{ super() }}
	<link type="text/css" rel="stylesheet" href="/static/css/dashboard.css">
	<script src="/static/js/maps.js"></script>
	<script src="/static/js/format.js"></script>
	<script src="/static/js/moment.min.js"></script>
{% endblock %}

{% block content %}

<div class="dashboardContentWrapper">

	<div class="dashboardLeftColumn">

		<div class="dashboardEmpty">
			<h1>Welcome to HeroTime!</h1>
			<h2>This is your personal dashboard.</h2>
			<p>Once you start making bookings, your offers and lessons will be displayed on this page.</p>

			<!-- CAH: Tine needs to come up with text that goes here, too. -->
			<p>Aenean tincidunt augue vitae eleifend pretium. Aliquam suscipit quis ipsum quis cursus. Vivamus tempus odio ac turpis ultrices porttitor. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Nam et malesuada libero, vel blandit mi. Duis vulputate, urna eget venenatis feugiat, massa ipsum sodales purus, vitae dictum diam odio id libero. In scelerisque iaculis tellus. Duis sed eros nec enim molestie fermentum.</p>
		</div>

		<div class="dashboardOffers">
			<h1>Pending Offers ({{proposals|length}})</h1>

			{% for proposal in proposals|sort(attribute='Proposal.prop_ts')  %}
			<div class="dashboardOffer" id="prop-{{proposal.Proposal.prop_uuid}}">
				<div class="dashboardOfferLeftColumn">
					<a href="/profile?hero={{proposal.display.prof_id}}">
						<img src="https://s3-us-west-1.amazonaws.com/htfileupload/htfileupload/{{proposal.display.prof_img}}">
					</a>
				</div>
				<div class="dashboardOfferCenterColumn">
					<a href="/profile?hero={{proposal.display.prof_id}}">
						<h3>{{proposal.display.prof_name}}</h3>
					</a>
					<h4>{{proposal.display.headline}}</h4>
					<div class="dashboardOfferIntro italic">{{proposal.Proposal.prop_desc}}</div>
				</div>

				<div class="dashboardOfferRightColumn">
					<div class="dashboardOfferRightColumnInfo">
						{% if proposal.buyer == True %}
						You offered ${{proposal.Proposal.prop_cost}}.
						{% else %}
						You were offered ${{proposal.Proposal.prop_cost}}.
						{% endif %}
					</div>

					<div class="dashboardOfferRightColumnInfo">
						{{proposal.Proposal.prop_ts.strftime('%A, %b %d %Y')}}<br>
						{{proposal.Proposal.prop_ts.strftime('%H:%M %p')}} - {{proposal.Proposal.prop_tf.strftime('%H:%M %p')}}
					</div>

					<div class="dashboardOfferRightColumnInfo">
						{{proposal.Proposal.prop_place}}
						<!-- CAH: This should open Google Maps with the meeting location marked. -->
						<a href="#" class="falseMap">(see map)</a>
					</div>
					<input type="button" class="reject dashboardActionButton" id="{{proposal.Proposal.prop_uuid}}" ch="{{proposal.Proposal.prop_cost}}" value="Cancel">
					{% if proposal.buyer == false %}
					<input type="button" class="accept dashboardActionButton" id="{{proposal.Proposal.prop_uuid}}" ch="{{proposal.Proposal.prop_cost}}" value="Accept">
					{% endif %}
					<!-- -->
				</div>
				<div class="clear"></div>
			</div>
			{% endfor %}
		</div>


		<div class="dashboardAppointments">
			<h1>Scheduled Lessons ({{appointments|length}})</h1>
			{% for appointment in appointments|sort(attribute='Proposal.prop_ts')  %}
			<div class="dashboardAppointment" id="appt-{{appointment.Proposal.prop_uuid}}">
				<div class="dashboardAppointmentLeftColumn">
					<a href="/profile?hero={{appointment.display.prof_id}}">
						<img src="https://s3-us-west-1.amazonaws.com/htfileupload/htfileupload/{{appointment.display.prof_img}}">
					</a>
				</div>
				<div class="dashboardAppointmentCenterColumn">
					<a href="/profile?hero={{appointment.display.prof_id}}">
						<h3>{{appointment.display.prof_name}}</h3>
					</a>
					<h4>{{appointment.display.headline}}</h4>
					<div class="dashboardAppointmentIntro italic">{{appointment.Proposal.prop_desc}}</div>
				</div>
				<div class="dashboardAppointmentRightColumn">
					<div class="dashboardAppointmentRightColumnInfo">
						{% if appointment.buyer == True %}
						You will pay ${{appointment.Proposal.prop_cost}}.
						{% else %}
						You will get paid ${{appointment.Proposal.prop_cost}}.
						{% endif %}
					</div>
					<div class="dashboardAppointmentRightColumnInfo">
						{{appointment.Proposal.prop_ts.strftime('%A, %b %d %Y')}}<br>
						{{appointment.Proposal.prop_ts.strftime('%H:%M %p')}} - {{appointment.Proposal.prop_tf.strftime('%H:%M %p')}}
					</div>
					<!-- CAH: Meeting address goes here. -->
					<div class="dashboardAppointmentRightColumnInfo">
						{{appointment.Proposal.prop_place}}
						<!-- CAH: This should open Google Maps with the meeting location marked. -->
						<a href="#" class="falseMap">(see map)</a>
					</div>

					<!-- CAH: The button should disappear 24 hours before the meeting. -->
					<input type="button" class="dashboardActionButton redButton" id="{{appointment.Proposal.prop_uuid}}" ch="{{appointment.Proposal.prop_cost}}" value="Cancel Lesson">
				</div>
				<div class="clear"></div>
			</div>
			{% endfor %}
		</div>

		<div class="dashboardMessages">
			<h1>Messages ({{messages|length}})</h1>
			{% for msg in messages|sort(attribute='UserMessage.msg_created')|reverse  %}
			<div class="dashboardMessage" id="msg-{{msg.UserMessage.msg_id}}">
				<p></p>
				<div class="dashboardMessageLeftColumn">
					<a href="/profile?hero={{msg.display.prof_id}}">
						<div class="messageSenderImage"><img src="https://s3-us-west-1.amazonaws.com/htfileupload/htfileupload/{{msg.display.prof_img}}"></div>
						<div class="messageSenderName">{{msg.display.prof_name}}</div>
					</a>
				</div>
				<div class="dashboardMessageCenterColumn">
					<div class="messageSubjectLine">{{msg.UserMessage.msg_subject}}</div>
					<div class="messageIntro italic">{{msg.UserMessage.msg_content}}</div>
				</div>
				<div class="dashboardMessageRightColumn">
					<div class="messageDatetime">{{msg.UserMessage.msg_created.strftime('%b %d at %I:%M %p')}}</div>
					<div class="messageView"><a href="/inbox/message/{{msg.UserMessage.msg_id}}"><button id="messageViewButton" class="whiteButton messageViewButton">View/Reply</button></a></div>
				</div>
				<div class="clear"></div>
			</div>
			{% endfor %}
		</div>
	</div>

	<div class="dashboardRightColumn">
		<a href="/profile"><img src="{{profile_img}}"></a>
		<a href="/profile"><h3>{{bp.prof_name}}</h3></a>
		<h4>{{bp.headline}}</h4>
		<div class="dashboardBasicInfo">
			<div class="dashboardInfoBox">{{bp.location}}</div>
			<div class="dashboardInfoBox">{{bp.industry}}</div>
			<div class="dashboardInfoBox">
				{% if bp.reviews == 0 %}
					No Reviews
				{% else %}
					{{ '%0.1f' | format(bp.rating|float) }} out of 5 stars <a href="#">({{bp.reviews}} Reviews)</a>
				{% endif %}
			</div>
		</div>
		<form method="link" action="/edit">
			<input type="submit" class="whiteButton" value="Edit Profile">
		</form>
	</div>

</div>

<script src="/static/js/sendmsg.js"></script>
<script>

$(document).ready(function() {

    $('.accept').click(function () {
        var id = this.id;
        var ch = $(this).attr("ch");
        var csrf = "{{ csrf_token() }}";

        console.log(['this is get started', id, ch]);

        var fd = new FormData();
        fd.append('proposal_id', id);
        fd.append('proposal_stat', 'accept');
        fd.append('proposal_challenge', ch);

        var xhr = new XMLHttpRequest();
        xhr.open('post', "/proposal/accept", true);
        xhr.setRequestHeader("X-CSRFToken", csrf);
		xhr.send(fd);
		console.log('sent');

        xhr.onreadystatechange = function(e) {
            if (4 == this.readyState) {
                if (this.status == 200) {
                    console.log(['xhr post complete ', e]);
                    console.log(xhr.responseText);
                    openAlertWindow('Success.');
					document.write(xhr.responseText);
                } else if (this.status == 400) {
                    msg = JSON.parse(xhr.responseText);
                    console.log(['xhr post complete, err=400 ', e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else if (this.status == 500) {
                    msg = JSON.parse(xhr.responseText);
                    console.log(['xhr post complete, err=500 ', e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else if (this.status == 501) {
                    msg = JSON.parse(xhr.responseText);
                    console.log(['xhr post complete, err=501 ', e]);
                    msg = JSON.parse(xhr.responseText);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else {
                    msg = JSON.parse(xhr.responseText);
                    console.log(['xhr post complete, err=?? ', this.status,  e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                }
            }
        };
        return false;
    });


   $('.redButton').click(function () {
        var id = this.id;
        var ch = $(this).attr("ch");
        var csrf = "{{ csrf_token() }}";
		var sid = "#appt-" + id;

        var fd = new FormData();
        fd.append('appt_id', id);
        fd.append('appt_stat', 'cancel');
        fd.append('appt_challenge', ch);

        var xhr = new XMLHttpRequest();
        xhr.open('post', "/appointment/cancel", true);
        xhr.setRequestHeader("X-CSRFToken", csrf);
        xhr.send(fd);

        //catch response.  make any modificaitons.
        xhr.onreadystatechange = function(e) {
            if (4 == this.readyState) {
                if (this.status == 200) {
                    console.log(['xhr post complete ', e]);
                    console.log(xhr.responseText);
					$(sid).remove();
					msg = JSON.parse(xhr.responseText);
					openAlertWindow('Success.\n' + msg['usrmsg']);
                } else if (this.status == 400) {
                    console.log(['xhr post complete, err=500 ', e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else if (this.status == 500) {
                    console.log(['xhr post complete, err=500 ', e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else if (this.status == 501) {
                    console.log(['xhr post complete, err=501 ', e]);
                    msg = JSON.parse(xhr.responseText);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else {
                    console.log(['xhr post complete, err=?? ', this.status,  e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                }
            }
        };

        return false;
    });


   $('.reject').click(function () {
        var id = this.id;
        var ch = $(this).attr("ch");
        var csrf = "{{ csrf_token() }}";
        var sid = "#prop-" + id;

        var fd = new FormData();
        fd.append('proposal_id', id);
        fd.append('proposal_stat', 'reject');
        fd.append('proposal_challenge', ch);

        var xhr = new XMLHttpRequest();
        xhr.open('post', "/proposal/reject", true);
        xhr.setRequestHeader("X-CSRFToken", csrf);
        xhr.send(fd);

        //catch response.  make any modificaitons.
        xhr.onreadystatechange = function(e) {
            if (4 == this.readyState) {
                msg = JSON.parse(xhr.responseText);
                if (this.status == 200) {
                    console.log(['xhr post complete ', e]);
                    console.log(xhr.responseText);
                    openAlertWindow('Success.\n' + msg['usrmsg']);
                    $(sid).remove();
                } else if (this.status == 500) {
                    console.log(['xhr post complete, err=500 ', e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else if (this.status == 501) {
                    console.log(['xhr post complete, err=501 ', e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                } else {
                    console.log(['xhr post complete, err=?? ', this.status,  e]);
                    openAlertWindow('Failure: ' + msg['usrmsg']);
                }
            }
        };

        return false;
    });

	$('.falseMap').click(function () {
		openAlertWindow('Sorry! Not available yet');
		return false;
	});

});

</script>

{% endblock %}
