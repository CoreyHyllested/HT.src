{% extends "ht_header.html" %}

{% block head %}
	{{ super() }}
	<!-- <link type="text/css" rel="stylesheet" href="/static/css/recovery.css"> -->

	{% assets "sass_settings" %}
		<link type="text/css" rel="stylesheet" href="{{ ASSET_URL }}"></script>
	{% endassets %}	
{% endblock %}

{% block content %}

<div class="settingsContentWrapper">

	{% if errmsg != none %}
	<script>
		openAlertWindow('{{errmsg}}');
	</script>
	{% endif %}

	<form id="editSettingsForm">
		<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
		<div class="formContainer">

			<div class="formInstruction">Account Settings</div>
			
			<div class="formFieldInfo first">Your legal name (different from your public profile name - this is kept private)</div>
			<div class="formFieldError"></div>
			{{form.set_input_name(placeholder="Your Name", class="formField span12")}}

			<div class="formFieldInfo">Your email address</div>
			<div class="formFieldError"></div>
			{{form.set_input_email(placeholder="Your Email", class="formField span12")}}

			{% if unverified_email == True %}
				<div>
					Your email is unverified.
					<button class="whiteButton" id="verify-email">Verify email</button>
				</div>
			{% endif %}

			<div class="formFieldInfo">Change your password</div>
			<div class="formFieldError"></div>
			{{form.set_input_newpass(placeholder="New password", class="formField span12")}}
			{{form.set_input_verpass(placeholder="Verify password", class="formField span12")}}
			<div id="passMeter"></div>

			<div class="formFieldInfo notice">Enter current password to save changes.</div>
			<div class="formFieldError"></div>
			{{form.set_input_curpass(placeholder="Current password", class="formField span12", autocomplete="off")}}

			<div class="settingsFormPageFooter">
				<div class="settingsFormButtonContainer">
					<button class="blueButton settingsFormButton" id="set-save">Save Settings</button>

					<button class="whiteButton settingsCancelButton">Cancel</button>
				</div>
				<div class="settingsFormStatus"></div>
			</div>	
		</div>
	</form>

	<div class="clear"></div>
</div>
<div class="clear"></div>

<script type="text/javascript" src="/static/js/zxcvbn.js"></script>
<script type="text/javascript" src="/static/js/jquery.password.strength.js"></script>
<script>
$(document).ready(function() {

	// Jquery Password Strength Plugin - http://www.sitepoint.com/developing-password-strength-plugin-jquery/

	$("#set_input_verpass").keyup(function(){
		initializeStrengthMeter();
	});

	$("#set_input_newpass").keyup(function(){
		if ($("#set_input_verpass").val() != "") {
			initializeStrengthMeter();
		}
	});

	$('#verify-email').on("click", function(e) {
		e.preventDefault();
		var dataObj = new Object();
		dataObj.hero = "{{bp.prof_id}}";
		dataObj.next = "modal";
		dataObj.nexturl = "{{ nexturl }}";
		$.each(dataObj, function(k, v) { console.log(k+ ": " + v); });
		openModalWindow("/email/request-response/me", ".recoveryContentWrapper", JSON.stringify(dataObj));
	});

	$(".settingsCancelButton").click(function(e){
		e.preventDefault();
		window.location.href = "/dashboard";
	});

	$(".settingsFormButton").click(function(e){
		e.preventDefault();
		saveSettings();
	});

});


function saveSettings() {

	var fd = new FormData($('#editSettingsForm')[0]);

	$(".settingsFormStatus").html("Saving...").fadeIn();

	// Remove error indicators

	$("#passMeter").slideUp().html("");
	$(".formFieldError").slideUp().html("");
	$(".formField").css("border-color", "#e1e8ed");

	$.ajax({ url	: "/settings/update",
			type	: "POST",
			data : fd,
			processData: false,
  			contentType: false,
			success : function(response) {

			 	console.log("AJAX Success - settings saved.");		 	

			 	$("#set_input_newpass, #set_input_verpass, #set_input_curpass").val('');
			 	$("#passMeter").slideUp().html("");
				$(".settingsFormStatus").html("<span class='success'>Changes Saved.</span>").fadeIn(400);

				setTimeout(function() {
					$('.settingsFormStatus').fadeOut(400);
				}, 1600 );
			}, 
			error: function(xhr, status, error) {
				console.log("AJAX Error - settings not saved.");

				var err = JSON.parse(xhr.responseText);
				var errors = err.errors;
				
				console.log("FORM ERRORS:");

				console.log(JSON.stringify(errors));

				showErrors(errors);

			}
	});
	return false;

}

function showErrors(errors) {

	$(".settingsFormStatus").empty();

	// iterate thru errors, create status messages, highlight form elements.
	$.each(errors, function(e, error){
		// "e" here would be the form element name that has the error, e.g. "prof_name"
		var element = "#"+e;

		if (element == "set_input_verpass") {
			element = "set_input_newpass";
		}

		console.log("showErrors: element: "+element);	

		$(element).prev(".formFieldError").html(error).slideDown();

		$(element).css("border-color", "#e75f63");

	});

	$(".settingsFormStatus").html("<span class='error'>There was a problem - please check the form.</span>").fadeIn();

}

function initializeStrengthMeter() {
	$("#passMeter").PasswordStrengthManager({
		password: $("#set_input_newpass").val(),
		confirm_pass : $("#set_input_verpass").val(),
		blackList : ["efewf"], 
		minChars : '5',
		maxChars : '25',
		advancedStrength : false
	});
}
</script>
{% endblock %}

