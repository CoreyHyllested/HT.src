{% extends "ht_header.html" %}

{% block head %}
	{{ super() }}
	<link type="text/css" rel="stylesheet" href="/static/css/schedule.css">
	<script src="/static/js/moment.min.js"></script>
	<script src="/static/js/date.js"></script>
	<script src="/static/js/calendar.js"></script>
	<script src="/static/js/calendar1.js"></script>
	<script src="/static/js/maps.js">
	<script src="/static/js/format.js"></script>
	<script src="/static/js/schedule.times.js"></script>
{% endblock %}

{% block content %}

<script>
	jQuery(function($) {
		$( "#datepicker" ).datepicker({
			inline: true
		});
	});

	jQuery(function($) {
		$('#datepicker').change(function() {
			var d1 = new Date(document.getElementById("datepicker").value);
		});
	});
</script>


<div class="scheduleContentWrapper">

	<div class="scheduleLeftColumn">
		<p>Lesson Request to</p>
		<h2>{{hp.prof_name}}</h2>
		<img src='https://s3-us-west-1.amazonaws.com/htfileupload/htfileupload/{{hp.prof_img}}'>

		<div class="scheduleLeftColumnInfo">Duration <span id="newslot-duration">?</span></div>
		<div class="scheduleLeftColumnInfo">Price <span id="newslot_price">${{hp.prof_rate}}/hour</span></div>
		<p>You will not be charged until after the lesson, and you may see the amount as pending on your credit card statement. If the request is accepted by {{hp.prof_name}}, your card will be securely processed. {{hp.prof_name}} will never get to see your credit card number.</p>
	</div>

	<div class="scheduleRightColumn">
		<form name="charge"   action="/proposal/create" method="POST"></form>
		<form name="schedule" action="/schedule" method="POST">
  			{{form.hidden_tag()}}


		<div class="scheduleIntro">
			<h3>Introduction</h3>
			<textarea placeholder="Tell {{hp.prof_name}} a little about yourself and what you want to learn during your lesson (optional)."></textarea>
		</div>
		
		<div class="scheduleTime">
			<h3>Date &amp; Time</h3>
			<input type="text" id="datepicker" placeholder="Today" readonly="readonly">


			<select id="newslot_starttime">
				<option selected="true" disabled>Start Time</option>

				<option>00:30 AM</option> <option>01:00 AM</option> <option>01:30 AM</option> <option>02:00 AM</option>
				<option>02:30 AM</option> <option>03:00 AM</option> <option>03:30 AM</option> <option>04:00 AM</option>
				<option>04:30 AM</option> <option>05:00 AM</option> <option>05:30 AM</option> <option>06:00 AM</option>
				<option>06:30 AM</option> <option>07:00 AM</option> <option>07:30 AM</option> <option>08:00 AM</option>
				<option>08:30 AM</option> <option>09:00 AM</option> <option>09:30 AM</option> <option>10:00 AM</option>
				<option>10:30 AM</option> <option>11:00 AM</option> <option>11:30 AM</option> <option>12:00 PM</option>
				<option>12:30 PM</option> <option>01:00 PM</option> <option>01:30 PM</option> <option>02:00 PM</option>
				<option>02:30 PM</option> <option>03:00 PM</option> <option>03:30 PM</option> <option>04:00 PM</option>
				<option>04:30 PM</option> <option>05:00 PM</option> <option>05:30 PM</option> <option>06:00 PM</option>
				<option>06:30 PM</option> <option>07:00 PM</option> <option>07:30 PM</option> <option>08:00 PM</option>
				<option>08:30 PM</option> <option>09:00 PM</option> <option>09:30 PM</option> <option>10:00 PM</option>
				<option>10:30 PM</option> <option>11:00 PM</option> <option>11:30 PM</option> <option>12:00 PM</option>
			</select>


			<select id="newslot_endtime">
				<option selected="true" disabled>End Time</option>

				<option>00:30 AM</option> <option>01:00 AM</option> <option>01:30 AM</option> <option>02:00 AM</option>
				<option>02:30 AM</option> <option>03:00 AM</option> <option>03:30 AM</option> <option>04:00 AM</option>
				<option>04:30 AM</option> <option>05:00 AM</option> <option>05:30 AM</option> <option>06:00 AM</option>
				<option>06:30 AM</option> <option>07:00 AM</option> <option>07:30 AM</option> <option>08:00 AM</option>
				<option>08:30 AM</option> <option>09:00 AM</option> <option>09:30 AM</option> <option>10:00 AM</option>
				<option>10:30 AM</option> <option>11:00 AM</option> <option>11:30 AM</option> <option>12:00 PM</option>
				<option>12:30 PM</option> <option>01:00 PM</option> <option>01:30 PM</option> <option>02:00 PM</option>
				<option>02:30 PM</option> <option>03:00 PM</option> <option>03:30 PM</option> <option>04:00 PM</option>
				<option>04:30 PM</option> <option>05:00 PM</option> <option>05:30 PM</option> <option>06:00 PM</option>
				<option>06:30 PM</option> <option>07:00 PM</option> <option>07:30 PM</option> <option>08:00 PM</option>
				<option>08:30 PM</option> <option>09:00 PM</option> <option>09:30 PM</option> <option>10:00 PM</option>
				<option>10:30 PM</option> <option>11:00 PM</option> <option>11:30 PM</option> <option>12:00 PM</option>				
			</select>
		</div>


		<div class="scheduleLocation">
			<h3>Location</h3>
			<!-- CAH: Prepopulate the field with default location (say, "UC Berkeley School of Information<br>102 S Hall Rd, Berkeley, CA 94720"), but allow the user to customize it. -->
			<input type="text" id="newslot_location" placeholder="Address" value="South Hall, Berkeley, CA 94705">
            <div class="scheduleMap" id="map-canvas"></div>
			<p></p>
		</div>

		<!--div class="scheduleBilling">
			<h3>Billing Address</h3>
			<input id="bill_name"   type="text" placeholder="Name">
			<input id="bill_street" type="text" placeholder="Street">
			<input id="bill_city"   type="text" placeholder="City">
			<input id="bill_state"  type="text" placeholder="State" maxlength="2">
			<input id="bill_zip"    type="text" placeholder="ZIP" maxlength="5">
		</div-->

		<!--div class="scheduleCard">
			<h3>Card Information</h3>
			<input type="text" placeholder="Card Number" maxlength="19">
			<input type="text" placeholder="Expiration (MM / YY)">		
			<input type="text" placeholder="Card Security Code" maxlength="4">
		</div-->
		
		<!-- Buttons -->
 		<input id="send_proposal" type="submit" class="blueButton schedulePostButton" value="Checkout"/>
		</form>

		<form method="link" action="/profile">
			<input type="submit" class="whiteButton scheduleCancelButton" value="Cancel">
		</form>
	</div>

	<div class="clear"></div>
</div>

<script>
	google.maps.event.addDomListener(window, 'load', initialize);
	$('#newslot_starttime').change(function() { update_time_diff({{hp.prof_rate}}); });
	$('#newslot_endtime').change(function() { update_time_diff({{hp.prof_rate}}); });
    if (document.getElementById("datepicker") != null) {
        document.getElementById("datepicker").value = moment().format("dddd, MMM D, YYYY");
    }


    $(document).ready(function() {
        $('#send_proposal').click(function() {
            $hero_acct = '{{hp.prof_id}}';
            $hero_name = '{{hp.prof_name}}';
            $cost = parseInt($('#newslot_price').val().replace(/,/g, ''), 10) * 100;
            $time = $('#newslot-duration').html();
            $desc = $('#newslot_description').val();
            $area = $('#newslot_location').val();
            $ts_d = $('#datepicker').val();
            $ts_h = $('#newslot_starttime').val();

            $tf_d = $('#datepicker').val();
            $tf_h = $('#newslot_endtime').val();

            $bp_name = '{{bp.prof_name}}';
            $bp_id   = '{{bp.prof_id}}';
            console.log('hero_acct = ' + $hero_acct + ' ;' + $hero_name);
            console.log('ts = ' + $ts_d+ ' ; ' + $ts_h);
            console.log('tf = ' + $tf_d+ ' ; ' + $tf_h);
            console.log('@ cost = ' + $cost);
            var srv_callback = function(res) {
                console.log('time = ' + $time);
                console.log('cost = ' + $cost);

                $.each(res.card, function(key, element) {
                        console.log('res.' + key + ' = ' + element);
                });

                var $csrf = $('<input type=hidden name=csrf_token />').val("{{ csrf_token() }}");
                var $stripe_tokn = $('<input type=hidden name=stripe_tokn />').val(res.id);
                var $stripe_card = $('<input type=hidden name=stripe_card />').val(res.card.id);
                var $stripe_name = $('<input type=hidden name=stripe_name />').val(res.card.name);
                var $stripe_city = $('<input type=hidden name=stripe_city />').val(res.card.address_city);
                var $stripe_stat = $('<input type=hidden name=stripe_stat />').val(res.card.address_state);
                var $stripe_cust = $('<input type=hidden name=stripe_cust />').val(res.card.customer);
                var $stripe_fngr = $('<input type=hidden name=stripe_fngr />').val(res.card.fingerprint);
                var $stripe_mail = $('<input type=hidden name=stripe_mail />').val(res.email);


                var $prop_hero =  $('<input type=hidden name=prop_hero />').val($hero_acct);
                var $prop_cost =  $('<input type=hidden name=prop_cost />').val($cost);
                var $prop_area =  $('<input type=hidden name=prop_area />').val($area);
                var $prop_desc =  $('<input type=hidden name=prop_desc />').val($desc);

                var $prop_s_date =  $('<input type=hidden name=prop_s_date />').val($ts_d);
                var $prop_s_hour =  $('<input type=hidden name=prop_s_hour />').val($ts_h);
                var $prop_f_date =  $('<input type=hidden name=prop_f_date />').val($tf_d);
                var $prop_f_hour =  $('<input type=hidden name=prop_f_hour />').val($tf_h);
                
                $('form[name="charge"]').append($csrf);
                console.log('append stripe');
                $('form[name="charge"]').append($stripe_tokn).append($stripe_card).append($stripe_cust).append($stripe_fngr).append($stripe_mail);
                $('form[name="charge"]').append($prop_hero).append($prop_cost).append($prop_area).append($prop_desc);
                $('form[name="charge"]').append($prop_s_date).append($prop_s_hour);
                $('form[name="charge"]').append($prop_f_date).append($prop_f_hour);
                $('form[name="charge"]').submit();
            };

            StripeCheckout.open({
                key: 'pk_test_ga4TT1XbUNDQ3cYo5moSP66n',
                amount:      $cost,
                address:     true,
                description: 'You will not be charged until one day before the meeting', 
                name:        $hero_name, 
                currency:    'usd',
                panelLabel:  'Checkout',
                token:      srv_callback
            });
            return false;
        });
    });



	
</script>
<!--script src="https://checkout.stripe.com/v2/checkout.js"></script-->
<script src="https://checkout.stripe.com/checkout.js"></script>

{% endblock %}
