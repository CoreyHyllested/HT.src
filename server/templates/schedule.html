{% extends "ht_header.html" %}

{% block head %}
	{{ super() }}
	<link type="text/css" rel="stylesheet" href="/static/css/schedule.css">
	<script src="/static/js/moment.min.js"></script>
	<script src="/static/js/date.js"></script>
	<script src="/static/js/calendar.js"></script>
	<script src="/static/js/calendar1.js"></script>
	<script src="/static/js/maps.js">
	<script src="/static/js/format.js"></script>
	<script src="/static/js/schedule.times.js"></script>
{% endblock %}

{% block content %}

<script>
	jQuery(function($) {
		$( "#datepicker" ).datepicker({
			inline: true
		});
	});

	jQuery(function($) {
		$('#datepicker').change(function() {
			var d1 = new Date(document.getElementById("datepicker").value);
		});
	});
</script>


<div class="scheduleContentWrapper">

	<div class="scheduleLeftColumn">
		<p>Lesson Request to</p>
		<h2>{{hp.prof_name}}</h2>
		<img src='https://s3-us-west-1.amazonaws.com/htfileupload/htfileupload/{{hp.prof_img}}'>

		<div class="scheduleLeftColumnInfo">Duration <span id="newslot-duration">?</span></div>
		<div class="scheduleLeftColumnInfo">Price <span id="newslot_price">${{hp.prof_rate}}/hour</span></div>
		<p>You will not be charged until after the lesson, and you may see the amount as pending on your credit card statement. If the request is accepted by {{hp.prof_name}}, your card will be securely processed. {{hp.prof_name}} will never get to see your credit card number.</p>
	</div>

	<div class="scheduleRightColumn">
		<div class="scheduleIntro">
			<h3>Introduction</h3>
			<textarea id="newslot_description" placeholder="Tell {{hp.prof_name}} a little about yourself and what you want to learn during your lesson (optional)."></textarea>
		</div>
		
		<div class="scheduleTime">
			<h3>Date &amp; Time</h3>
			<input type="text" id="datepicker" placeholder="Today" readonly="readonly">


			<select id="newslot_starttime">
				<option selected="true" disabled>Start Time</option>

				<option>00:30 AM</option> <option>01:00 AM</option> <option>01:30 AM</option> <option>02:00 AM</option>
				<option>02:30 AM</option> <option>03:00 AM</option> <option>03:30 AM</option> <option>04:00 AM</option>
				<option>04:30 AM</option> <option>05:00 AM</option> <option>05:30 AM</option> <option>06:00 AM</option>
				<option>06:30 AM</option> <option>07:00 AM</option> <option>07:30 AM</option> <option>08:00 AM</option>
				<option>08:30 AM</option> <option>09:00 AM</option> <option>09:30 AM</option> <option>10:00 AM</option>
				<option>10:30 AM</option> <option>11:00 AM</option> <option>11:30 AM</option> <option>12:00 PM</option>
				<option>12:30 PM</option> <option>01:00 PM</option> <option>01:30 PM</option> <option>02:00 PM</option>
				<option>02:30 PM</option> <option>03:00 PM</option> <option>03:30 PM</option> <option>04:00 PM</option>
				<option>04:30 PM</option> <option>05:00 PM</option> <option>05:30 PM</option> <option>06:00 PM</option>
				<option>06:30 PM</option> <option>07:00 PM</option> <option>07:30 PM</option> <option>08:00 PM</option>
				<option>08:30 PM</option> <option>09:00 PM</option> <option>09:30 PM</option> <option>10:00 PM</option>
				<option>10:30 PM</option> <option>11:00 PM</option> <option>11:30 PM</option> <option>12:00 PM</option>
			</select>


			<select id="newslot_endtime">
				<option selected="true" disabled>End Time</option>

				<option>00:30 AM</option> <option>01:00 AM</option> <option>01:30 AM</option> <option>02:00 AM</option>
				<option>02:30 AM</option> <option>03:00 AM</option> <option>03:30 AM</option> <option>04:00 AM</option>
				<option>04:30 AM</option> <option>05:00 AM</option> <option>05:30 AM</option> <option>06:00 AM</option>
				<option>06:30 AM</option> <option>07:00 AM</option> <option>07:30 AM</option> <option>08:00 AM</option>
				<option>08:30 AM</option> <option>09:00 AM</option> <option>09:30 AM</option> <option>10:00 AM</option>
				<option>10:30 AM</option> <option>11:00 AM</option> <option>11:30 AM</option> <option>12:00 PM</option>
				<option>12:30 PM</option> <option>01:00 PM</option> <option>01:30 PM</option> <option>02:00 PM</option>
				<option>02:30 PM</option> <option>03:00 PM</option> <option>03:30 PM</option> <option>04:00 PM</option>
				<option>04:30 PM</option> <option>05:00 PM</option> <option>05:30 PM</option> <option>06:00 PM</option>
				<option>06:30 PM</option> <option>07:00 PM</option> <option>07:30 PM</option> <option>08:00 PM</option>
				<option>08:30 PM</option> <option>09:00 PM</option> <option>09:30 PM</option> <option>10:00 PM</option>
				<option>10:30 PM</option> <option>11:00 PM</option> <option>11:30 PM</option> <option>12:00 PM</option>				
			</select>
		</div>


		<div class="scheduleLocation">
			<h3>Location</h3>
			<input type="text" id="newslot_location" placeholder="UC Berkeley School of Information, 102 S Hall Road, Berkeley, CA, United States">
            <div class="scheduleMap" id="map-canvas"></div>
			<p></p>
		</div>

		<!--div class="scheduleBilling">
			<h3>Billing Address</h3>
			<input id="bill_name"   type="text" placeholder="Name">
			<input id="bill_street" type="text" placeholder="Street">
			<input id="bill_city"   type="text" placeholder="City">
			<input id="bill_state"  type="text" placeholder="State" maxlength="2">
			<input id="bill_zip"    type="text" placeholder="ZIP" maxlength="5">
		</div>

		<div class="scheduleCard">
			<h3>Card Information</h3>
			<input type="text" placeholder="Card Number" maxlength="19">
			<input type="text" placeholder="Expiration (MM / YY)">		
			<input type="text" placeholder="Card Security Code" maxlength="4">
		</div-->
		
		<!-- Buttons -->
 		<input id="send_proposal" type="submit" class="blueButton schedulePostButton" value="Checkout..."/>
		<form method="post" action="/profile">
			<input type="hidden" name="hero" value="{{hp.prof_id}}">
			<input type="submit" class="whiteButton scheduleCancelButton" value="Cancel">
		</form>
	</div>

	<div class="clear"></div>
</div>

<script>
$(document).ready(function() {
	google.maps.event.addDomListener(window, 'load', initialize);
	$('#newslot_starttime').change(function() { update_time_diff({{hp.prof_rate}}); });
	$('#newslot_endtime').change(function() { update_time_diff({{hp.prof_rate}}); });
    if (document.getElementById("datepicker") != null) {
        document.getElementById("datepicker").value = moment().format("dddd, MMM D, YYYY");
    }


	$('#send_proposal').click(function(e) {
		e.preventDefault();
		$hero_acct = '{{hp.prof_id}}';
		$hero_name = '{{hp.prof_name}}';
		$cost = parseInt($('#newslot_price').val().replace(/,/g, ''), 10) * 100;
		$time = $('#newslot-duration').html();
		$desc = $('#newslot_description').val();
		$area = $('#newslot_location').val();
		$ts_d = $('#datepicker').val();
		$ts_h = $('#newslot_starttime').val();

		$tf_d = $('#datepicker').val();
		$tf_h = $('#newslot_endtime').val();

		$bp_name = '{{bp.prof_name}}';
		$bp_id   = '{{bp.prof_id}}';
		console.log('hero_acct = ' + $hero_acct + ';' + $hero_name);
		console.log('ts = ' + $ts_d+ ' ; ' + $ts_h);
		console.log('tf = ' + $tf_d+ ' ; ' + $tf_h);
		console.log('@ cost = ' + $cost);

		var srv_callback = function(res) {
			$.each(res.card, function(k, v) { console.log('res.' + k + ':' + v); });

			var fd = {};
			fd.csrf_token = "{{ csrf_token() }}";
			fd.stripe_tokn = res.id;
			fd.stripe_card = (res.card.id);
			fd.stripe_name = (res.card.name);
			fd.stripe_city = (res.card.address_city);
			fd.stripe_stat = (res.card.address_state);
			fd.stripe_cust = (res.card.customer);
			fd.stripe_fngr = (res.card.fingerprint);
			fd.stripe_mail = (res.email);
			fd.prop_hero =  ($hero_acct);
			fd.prop_cost =  ($cost);
			fd.prop_area =  ($area);
			fd.prop_desc =  ($desc);
			fd.prop_s_date = ($ts_d);
			fd.prop_s_hour = ($ts_h);
			fd.prop_f_date = ($tf_d);
			fd.prop_f_hour = ($tf_h);

			console.log('time = ' + $time);
			console.log('cost = ' + $cost);

			$.ajax({ url	: "/proposal/create",
					type	: "POST",
					data	: fd,
					success : function(data) {
						console.log(data);
						console.log(data.nexturl);
						console.log(data.usrmsg);
						window.location.href = data.nexturl;
					},
					error	: function(data) {
						console.log(data.responseText);
						var msg = JSON.parse(data.responseText);
						openAlertWindow(msg['usrmsg']);
					}
			});
		};

		StripeCheckout.open({
			key: 'pk_test_d3gRvdhkXhLBS3ABhRPhOort',
			amount:      $cost,
			address:     true,
			description: "You'll be charged after the meeting.",
			name:        $hero_name,
			currency:    'usd',
			panelLabel:  'Checkout',
			token:      srv_callback
		});
		return false;
	});
});
</script>

<!--script src="https://checkout.stripe.com/v2/checkout.js"></script-->
<script src="https://checkout.stripe.com/checkout.js"></script>

{% endblock %}
