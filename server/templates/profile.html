{% extends "ht_header.html" %}

{% block content %}
<script src="static/js/date.js"></script>
<script src="static/js/maps.js"></script>
<script src="static/js/format.js"></script>
<script src="static/js/slot_expand.js"></script>
<script src="static/js/view_more.js"></script>
<script src="static/js/calendar.js"></script>
<script src="static/js/calendar1.js"></script>
<script src="static/js/tab_switch.js"></script>
<script src="static/js/add_times.js"></script>
<script src="static/js/moment.min.js"></script>
<script src="https://checkout.stripe.com/v2/checkout.js"></script>

<script>
	  jQuery(function($) {
		  $( "#datepicker" ).datepicker({
  			  inline: true
  		  });
	  });
	  jQuery(function($) {
		  $( "#datepicker1" ).datepicker({
  			  inline: true
  		  });
	  });
	  jQuery(function($) {
		  $( "#datepicker2" ).datepicker({
  			  inline: true
  		  });
	  });
	  jQuery(function($) {
      $('#datepicker').change(function() {
				var d1 = document.getElementById("datepicker");
				var d2 = document.getElementById("datepicker1");
				var timeDiff = new Date(d2.value).getTime() - new Date(d1.value).getTime();
				if (timeDiff < 0 || (d2.value == "")) {
					document.getElementById("datepicker1").value = document.getElementById("datepicker").value;
				}
				update_time_diff({{hp.baserate}});
      });
	  });

	jQuery(function($) {
	  $('#datepicker2').change(function() {
	    document.getElementById("header").innerHTML = document.getElementById("datepicker2").value;
	    var c = {{timeslots|length}};
		for (var i = 1; i < c + 1; i++){
          if (document.getElementById("day-"+i).innerHTML != document.getElementById("datepicker2").value){
            document.getElementById(i).style.display = 'none';
            document.getElementById("slot-expand-"+i).style.display = 'none';
          }
          else {
          	document.getElementById(i).style.display = 'block';
          }
		};
	  });
	});

	  jQuery(function($) {
      $('#datepicker1').change(function() {
				var d1 = new Date(document.getElementById("datepicker").value);
				var d2 = new Date(document.getElementById("datepicker1").value);
				var timeDiff = d2.getTime() - d1.getTime();
				if (timeDiff < 0) {
                  document.getElementById("datepicker").value = document.getElementById("datepicker1").value;
				}
                  update_time_diff({{hp.baserate}});
			});
	  });
</script>

<div id="profile_pic">
	<img src="{{profile_img}}" style="height:534px; width:950px; display:block margin:0 auto;"/>
	<div id="profile_pic_box">
		<h1>{{hp.name}}</h1>
		<p>{{hp.headline| default('No headline')}}</p>
		<h3 id="profile_price"></h3><span> / hour</span>
		<div id="profile_pic_button_wrap">
			{% if hp is sameas bp %}
				<a href="edit" class="blueButton">Edit profile...
			{% else %}
				<a href="javascript:tab_switch('tab-prop', 'content-box-prop', 'true');" class="blueButton">Propose a meeting...
			{% endif %}
				</a>
			</div>
	</div>
</div>

<div id="info_box">
	<div id="about_me">
		<h2>About me</h2>
		<p id="about_text">{{hp.bio}}</p>
		<div id="button" onlick="javascript:view_more"></div>
	</div>

	<div id="at_glance">
		<h2>At a glance</h2>
		<ul>
			<li id="li_industry">{{hp.industry}}</li>
			<li id="li_location">{{hp.location}}</li>
			{% if hp.reviews == 0 %}
			<li id="li_rating">No reviews</li>
			{% else %}
			<li id="li_rating">{{ '%0.1f' | format(hp.rating|float) }} out of 5 stars<a href="javascript:tab_switch('tab-revs', 'content-box-revs');"> ({{hp.reviews}} reviews)</a></li>
			{% endif %}
			<li id="li_url"><a href="{{hp.url}}" target="_blank">{{hp.url}}</a></li>
			<li id="li_rate"></li>
		</ul>
	</div>

	<div class="clear"></div>
</div>

<div id="content-box-cal" class="content-box">
	<ul id="tabs">
		<li id="tab-cal" class="active"><p><img src="static/img/calendar-active.svg" alt="Calendar" />Calendar</p></li>
		<a href="javascript:tab_switch('tab-revs', 'content-box-revs');"><li id="tab-revs" class="inactive"><p><img src="static/img/reviews-inactive.svg" alt="{{hp.reviews}} Reviews" />{{hp.reviews}} Reviews</p></li></a>
	</ul>

	<div id="content-top"></div>
	<div id="appointments">
		<h2 id="header"></h2>

		<div id="make_proposal_wrap">
			<h3>{% if hp is sameas bp %}Your calendar will go here {% else %}Meet this Hero.{% endif %}</h3>
			{% if hp is sameas bp %}
			{% else %}
			<div id="make_proposal_button_wrap">
				<a href="javascript:tab_switch('tab-prop', 'content-box-prop', 'true');" class="whiteButton makeProposalButton">
				Propose a meeting...
				</a>
			</div>
			{% endif %}
		</div>
	</div>
	<div style="clear: both"></div>
</div>

<div id="content-box-revs" class="content-box">
	<ul id="tabs">
		<a href="javascript:tab_switch('tab-cal', 'content-box-cal');"><li id="tab-cal" class="inactive"><p><img src="static/img/calendar-inactive.svg" alt="Calendar" />Calendar</p></li></a>
		<li id="tab-revs" class="active"><p><img src="static/img/reviews-active.svg" alt="{{hp.reviews}} reviews" />{{hp.reviews}} Reviews</p></li>
	</ul>
	<div id="content-top"></div>
	<div id="reviews">
		{% if hp.reviews == 0 %}
		<h2>No reviews available</h2>
		{% else %}
		<h2>Average rating:  {{ '%0.1f' | format(hp.rating|float)}} out of 5 stars</h2>
		{% endif %}

		{% for review in revs %}
		<div class="review_wrap">
			<div class="profile_preview">
				<a href='#'><img src="https://s3-us-west-1.amazonaws.com/htfileupload/htfileupload/{{review[7]}}" class="profile_preview_pic"/> </a>
				<span class="profile_preview_price">${{review[10]}}<span class="disabled"> / hour</span></span>				
				<div class="profile_preview_info">
					<p><a href="#">{{review[4]}}</a></p>
					<p>{{review[6]}}</p>
					<p>{{'%0.1f' | format(review[9]|float)}} out of 5<a href="#"> ({{review[8]}} reviews)</a></p>
					<p><span class="disabled">{{review[5]}}</span></p>
				</div>
			</div>

			<div class="review">
				<p>Transaction with {{review[4]}} occurred in {{review.ts.strftime('%B %Y')}}</p>
				<p><script>star_rating({{review[1]}});</script></p>
				<p>{{review.text}}</p>
			</div>
		</div>
		{% endfor %}

		<!--div class="show_more">Show more reviews (29 remaining)</div-->
		<div class="clear"></div>
	</div>
	<div style="clear: both"></div>
</div>


<div class="clear"></div>
</div>

<div id="content-box-prop" class="content-box">
	<ul id="tabs">
		<li id="tab-prop" class="active"><p><img src="static/img/calendar-active.svg" alt="Calendar" />Calendar</p></li>
		<a href="javascript:tab_switch('tab-revs', 'content-box-revs');"><li id="tab-revs" class="inactive"><p><img src="static/img/reviews-inactive.svg" alt="{{hp.reviews}} reviews" />{{hp.reviews}} reviews</p></li></a>
	</ul>
	<div id="content-top"></div>

	{% if hp is sameas bp %} 
	<h2> DANGER WILL ROBINSON! </h2>
	{% else %}

	<div id="newslot">
		<form name=charge action=/charge method=POST></form>
		<h2> Make proposal </h2>
		
		<form name="newts" action=/profile method=POST>
			{{ntsform.hidden_tag()}}
			{{ntsform.hero()}}

			<label id="newslot-label-start">Starting time</label>
			{{ntsform.newslot_starttime()}}
			{{ntsform.datepicker(class="newslot-startdate", readonly="readonly")}}

			<label id="newslot-label-end">Ending time</label>
			{{ntsform.newslot_endtime}}
			{{ntsform.datepicker1(class="newslot-enddate", placehoder="Today", readonly="readonly")}}

			<label id="newslot-label-duration">Total duration</label>
			<span id="newslot-duration"> </span>
			
			<label id="newslot-label-price">Listed price</label>
			<label id="newslot-label-dollar">$</label>
			{{ntsform.newslot_price(onkeypress="return isNumberKey(event)", maxlength="9")}}
			<label id="newslot-label-rate">This person's default rate is ${{hp.baserate}} / hour</label>

			
			<label id="newslot-label-location">Location</label>
			{{ntsform.newslot_location(placeholder=" ")}}
			
	        <div id="map-canvas"></div>

			<label id="newslot-label-description">Message to {{hp.name}}</label>
			{{ntsform.newslot_description}}


			<label id="newslot_label_cc_name">Credit Card Name:</label>
			{{ntsform.newslot_ccname}}

			<label id="newslot_label_cc_number">Credit Card Number:</label>
			{{ntsform.newslot_ccnbr}}

			<label id="newslot_label_cc_expdate">Credit Card Expiration:</label>
			{{ntsform.newslot_ccexp}}

			<label id="newslot_label_cc_cvv">Credit Card CCV:</label>
			{{ntsform.newslot_cccvv}}


			<div id="newslot-notif1">
				<p>By making a direct offer to a person, you get an opportunity to book an appointment outside of time slots already listed for sale.</p> <br />
				<p>You can also use direct offers to customize listed time slots: merge two or more slots together, change location, negotiate price, etc.</p>
			</div>

			<div id="newslot-notif2">
				<p>The exact address of the proposed meeting place is required.</p> <br />
				<p>If your search doesnâ€™t return the proper location, please make sure you pinpoint it manually by dragging the marker.</p>
			</div>

			<div id="newslot-notif3">
				Want to tell this person something about your offer? This is your chance to do so.
			</div>

			<div id="proposal-buttons">
				<div id="to_calendar_wrap">
					<a href="javascript:tab_switch('tab-cal', 'content-box-cal', 'true');" class="whiteButton toCalendar">Back to profile</a>
				</div>
				<div id="proposal_send_wrap">
					<input id='send_proposal' type="submit" class="blueButton newSlotList" value="Send proposal"/>
				</div>
			</div>
		</form>
	</div>
	{% endif %}


</div>

<script>
	//var jq = $.noConflict();
	$("#today_button").click(function() {
		var today = moment().format("dddd, MMM D, YYYY");
		$("#datepicker2").datepicker('setDate', today);
		document.getElementById("header").innerHTML = today;
		//moment().format("dddd, MMM D, YYYY");
	    var c = {{timeslots|length}};
		for (var i = 1; i < c + 1; i++){
          if (document.getElementById("day-"+i).innerHTML != today){
            document.getElementById(i).style.display = 'none';
            document.getElementById("slot-expand-"+i).style.display = 'none';
          }
          else {
          	document.getElementById(i).style.display = 'block';
          }
		};
	});
    //ensure enter doesn't submit form
    $("form[name=newts]").bind("keypress", function (e) {
        if (e.keyCode == 13) {
            return false;
        }
    });

    google.maps.event.addDomListener(window, 'load', initialize);
	document.getElementById("profile_price").innerHTML = "$" + format({{hp.baserate}});
	document.getElementById("li_rate").innerHTML = "$" + format({{hp.baserate}}) + " / hour";
	$('#newslot_starttime').change(function() {
		update_time_diff({{hp.baserate}});
	});
	$('#newslot_endtime').change(function() {
		update_time_diff({{hp.baserate}});
	});
	document.getElementById("header").innerHTML = moment().format("dddd, MMM D, YYYY");
    document.getElementById("datepicker").placeholder = moment().format("dddd, MMM D, YYYY");
	document.getElementById("datepicker1").placeholder = moment().format("dddd, MMM D, YYYY");
	document.getElementById("newslot-label-rate").innerHTML = "This person's default rate is $" + format({{hp.baserate}}) + " / hour"
	window.onload = function() {
      var today = new Date();
      today.setDate(today.getDate()-1);
	  var c = {{timeslots|length}};
	  for (var i = 1; i < c + 1; i++){
	  	var date = new Date(document.getElementById("day-"+i).innerHTML);
	  	var diff = today - date;
        if (today - date > 0){
          document.getElementById(i).style.display = 'none';
          document.getElementById("slot-expand-"+i).style.display = 'none';
        }
      }
	};
</script>

<script>
	$(document).ready(function() {
		$('#send_proposal').click(function() {

			
			$hero_acct = '{{hp.heroid}}';
			$hero_name = '{{hp.name}}';
			$time = $('#newslot-duration').html();
			$cost = parseInt( $('#newslot_price').val(), 10) * 100;
			$desc = $('#newslot_description').val();
			$area = $('#newslot_location').val();

			$bp_name = '{{bp.name}}';
			$bp_id   = '{{bp.heroid}}';
			console.log('hero_acct = ' + $hero_acct + ' ;' + $hero_name);
//			alert('Seller: ' + $hero_name + '\nSellID: ' + $hero_acct + '\n' + $time + ' @ $' + $cost + '\nMeet: ' + $area + '\nFor: ' + $desc + '\nBuyer:' + $bp_name);

			var srv_callback = function(res) {
				console.log('srv_callback is happening');
				console.log('time = ' + $time);
				console.log('cost = ' + $cost);

				/*
				$.each(res.card, function(key, element) {
					    console.log('res.' + key + ' = ' + element);
				});
				res.id = tok_3dAR0tkCHTAETp 
				res.livemode = false 
				res.created = 1394322237 
				res.used = false 
				res.object = token 
				res.type = card 
				res.card = [object Object] 
				res.email = corey.hyllested@gmail.com 
				
				[[res.card] == 
					res.card.id = card_3dAUcwyJebTMrO 
					res.card.id.object = card 
					res.last4 = 4242 
					res.type = Visa 
					res.exp_month = 8 
					res.exp_year = 2015 
					res.fingerprint = cOBLtIWQiyFZUGvf 
					res.customer = null 
					res.country = US 
					res.name = Corey Hyllested 
					res.address_line1 = Apartment T-331 
					res.address_line2 = null 
					res.address_city = Boulder 
					res.address_state = CO 
					res.address_zip = 80305 
					res.address_country = United States 
				]
				*/


				console.log('create csrf');
				var $csrf = $('<input type=hidden name=csrf_token />').val("{{ csrf_token() }}");
				console.log('create stripe');
			   	var $stripe_tokn = $('<input type=hidden name=stripe_tokn />').val(res.id);
			   	var $stripe_card = $('<input type=hidden name=stripe_card />').val(res.card.id);
			   	var $stripe_cust = $('<input type=hidden name=stripe_cust />').val(res.card.customer);
			   	var $stripe_fngr = $('<input type=hidden name=stripe_fngr />').val(res.card.fingerprint);

				console.log('create prop');
			   	var $prop_hero =  $('<input type=hidden name=prop_hero />').val($hero_acct);
			   	var $prop_time =  $('<input type=hidden name=prop_time />').val($);
			   	var $prop_cost =  $('<input type=hidden name=prop_cost />').val($cost);
			   	var $prop_area =  $('<input type=hidden name=prop_area />').val($area);
			   	var $prop_desc =  $('<input type=hidden name=prop_desc />').val($desc);

				
				console.log('append CSRF');
				$('form[name="charge"]').append($csrf);
				console.log('append stripe');
				$('form[name="charge"]').append($stripe_tokn).append($stripe_card).append($stripe_cust).append($stripe_fngr);
				console.log('append props');
				$('form[name="charge"]').append($prop_hero).append($prop_time).append($prop_cost).append($prop_area).append($prop_desc);
				$('form[name="charge"]').submit();
			};

			StripeCheckout.open({
				key: 'pk_test_ga4TT1XbUNDQ3cYo5moSP66n',
				amount:		 $cost,
				address:     true,
				description: $desc,
				name:		 $hero_name, 
				currency:	 'usd',
				panelLabel:	 'Checkout',
				token:		srv_callback
			});
			return false;
		});
	});
</script>

{% endblock %}
