{% extends "ht_header.html" %}

{% block head %}
	{{ super() }}
	<link type="text/css" rel="stylesheet" href="/static/css/message.css">
	<link type="text/css" rel="stylesheet" href="/static/css/inbox.css">
{% endblock %}


{% block content %}

<div class="inboxContentWrapper">
	<div class="inboxMessagesHeader">
		<div class="inboxMessagesHeaderLeft">
			<div class="inboxLeftNavigation">
				<a href="/inbox" title="Back to Inbox" class="navItem"><i class="fa fa-arrow-circle-left"></i> Back to Inbox</a>
			</div>
			<div class="inboxMessagesTitle">
			</div>	
		</div>
		<div class="inboxMessagesHeaderRight">
			<div class="inboxMessagesHeaderSubject"></div>	
		</div>			
	</div>
  
  	<div class="container">
		<div class="inboxLeftColumn">
			<div class="inboxNavContainer">
				<!--a href="/compose"><button type="button" class="composeButton">COMPOSE</button></a-->
				<ul class="inboxNavList">
					<div class="inboxNavItem" id="mainLink">INBOX<i class="fa fa-envelope-o"></i></div>
					<div class="inboxNavItem" id="archiveLink">ARCHIVE<i class="fa fa-archive"></i></div>
				</ul>
			</div>
		</div>

		<div class="inboxRightColumn">
			<div class="inboxView inboxMain">
				<ul class="inboxWell" id="threads">

					{% for msg in unread|sort(attribute='UserMessage.msg_created')|reverse %}
					<li class="message {% if msg.UserMessage.msg_opened is none %}unread{% endif %}" data-id="{{msg.UserMessage.msg_id}}">
						<div class="msg messageUser">{{msg.display.prof_name}}</div>
						<div class="msg messageSubjectLine">
							{{msg.UserMessage.msg_subject}}
						</div>
						<div class="messageArchive"><i class="fa fa-archive"></i></div>
						<div class="msg messageDate">{{msg.UserMessage.msg_created.strftime('%b %d at %I:%M %p')}}</div>
					</li>
					{% endfor %}

				</ul>  
			</div>
	
			<div class="inboxView inboxArchive">
				<ul class="inboxWell" id="threads">
					{% for msg in archived|sort(attribute='UserMessage.msg_created')  %}
					<li class="message" data-id="{{msg.UserMessage.msg_id}}">
						<div class="msg messageUser">{{msg.display.prof_name}}</div>
						<div class="msg messageSubjectLine">
							{% if msg.UserMessage.msg_opened is none %}<b>{% endif %}
							{{msg.UserMessage.msg_subject}}
							{% if msg.UserMessage.msg_opened is none %}</b>{% endif %}
						</div>
						<div class="messageArchive"><a href="" name="Restore Message"><i class="fa fa-level-up"></i></a></div>
						<div class="msg messageDate">{{msg.UserMessage.msg_created.strftime('%b %d at %I:%M %p')}}</div>
					</li>
					{% endfor %}
				</ul>  
			</div>
		</div><!--right column-->
	</div><!--empty, container-->

</div>


<script>
$(document).ready(function() {

	var numInbox = {{unread|length}};
	var numArchived = {{archived|length}};

	$('.inboxMessagesTitle').html("Inbox ("+numInbox+")");

	$(".composeBodyContainer").hide();

	$('.msg').click(function() {

		var thisSubject = $(this).parent().children(".messageSubjectLine").text();

		var msg_id = $(this).parent().data("id");
		var fd = new FormData();
		fd.append('msg', msg_id);
		fd.append('csrf_token', "{{ csrf_token() }}");
		console.log('msg_clicked = ' + msg_id);
		$.ajax({ url	: "/message",
				 type	: "POST",
				 data : {'message': msg_id, 'csrf_token' : '{{ csrf_token() }}' },
				 success : function(data) {
					var inner = $(data).find('.messageRightColumn').html();
					//console.log('data', data);
					//console.log('data', inner);
					$('.inboxRightColumn').html(inner);
					$('.inboxMessagesTitle').empty();
					$('.inboxLeftNavigation').show();
					$('.inboxMessagesHeaderSubject').text(thisSubject);

					$('#sendMessage').bind('click', sendmessage_js);
				}
		});
	});

	$('#mainLink').click(function() {
		$('.inboxLeftNavigation').hide();
		$('.inboxMessagesHeaderSubject').empty();
		$('.inboxMessagesTitle').html("Inbox ("+numInbox+")");
		if ($('.messageThread').length == 0) {
			$('.inboxView').hide();
			$('.inboxMain').show();
		} else {
			window.location.replace("/inbox");
		}
	});

	$('#archiveLink').click(function() {
		$('.inboxMessagesHeaderSubject').empty();
		$('.inboxLeftNavigation, .inboxView').hide();
		$('.inboxMessagesTitle').html("Archive ("+numArchived+")");		
		$('.inboxArchive').show();
	});

	$('.messageArchive').click(function() {
		var msg_id = $(this).parent().data("id");
		var fd = new FormData();
		console.log("clicked archive: "+msg_id);
		fd.append('msg', msg_id);
		fd.append('csrf_token', "{{ csrf_token() }}");
		fd.append('action', 'archive');
		$.ajax({ url	: "/message",
				 type	: "POST",
				 data : {'message': msg_id, 'csrf_token' : '{{ csrf_token() }}', 'action':'archive' },
				 success : function(data) {
					window.location.replace("/inbox");
				}
		});
	});
});
</script>
<script src="/static/js/sendmsg.js"></script>


{% endblock %}
